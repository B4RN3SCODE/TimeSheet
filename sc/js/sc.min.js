/* sc
 * Snake Charmer JS pseudo-Framework
 * @author		Tuler J barnes
 * @contact		b4rn3scode@gmail.com
 **/
"use strict";var SC=function(t){this._config=t&&"object"==(typeof t).toLowerCase()?t:{},this._$="undefined"==typeof jQuery?-1:jQuery,this._themeData={},this._notificationData={},this._widget=-1===this._$?"":this._$('<div id="SCWidget" class="sc_main" style="z-index:999;"></div>'),this._widgetElmsRemoved=[],this._sidebar=-1===this._$?"":this._$('<div id="SCSB" class="sc_main" style="z-index:999;"><div class="bigchat"><div id="ChatClose" class="header"><div class="name"></div><div class="time"></div><div class="close">Close</div></div><div class="primarychat"></div></div></div>'),this._displayState={widget:!1,sidebar:!1},this._defaultGetThemeUri="//www.conversionvoodoo.com/sc/include/getTheme.php",this._defaultGetNotifDataUri="//www.conversionvoodoo.com/sc/include/getNotifData.php",this._defaultEventTriggeredUri="//www.conversionvoodoo.com/sc/include/eventTriggered.php",this._defaultNotifSeenUri="//www.conversionvoodoo.com/sc/include/notifSeen.php",this._notificationSoundFile="//www.conversionvoodoo.com/sc/media/notif.mp3",this._audio=null,this._eventCookieName="snevdat",this._defaultCookieExpire=10,this._dispatchedCodes=[],this.ini=function(){var t=window.location;if(this.installJsCss(),-1==this._$||"undefined"==typeof this._$)return console.error("Snake Charmer Relies on jQuery. Please include jQuery library on your web page"),!1;var i=["license","themeId"];for(var e in i)if(!(i[e]in this._config)){console.info("Using default configuration for Snake Charmer"),this._config=void 0;break}"undefined"==typeof this._config?this._config=this.getDefaultConfig():this._config.pageUri=this._config.pageUri&&this._config.pageUri.length>0?this._config.pageUri:t.protocol+"//"+t.hostname+t.pathname,this._audio=new Audio(this._notificationSoundFile),this.getThemeData()},this.installJsCss=function(){this._$("head").append('<link type="text/css" rel="stylesheet" href="//www.conversionvoodoo.com/sc/css/style.css"><script src="//www.conversionvoodoo.com/sc/js/autosize.min.js"></script>')},this.getDefaultConfig=function(){var t={},i=this._$("#SCJS").attr("src"),e=i.split("?")[1].split("&"),n=[];for(var o in e)n=e[o].split("="),t[n[0]]=n[1];return t.pageUri=window.location.protocol+"//"+window.location.hostname+window.location.pathname,t},this.ajax=function(){var t,i,e,n,o,a=arguments,s=!1;if(a.length<2)return console.error("Invalid arguments passed to ajax function. Required: target_url, data_to_send"),!1;for(var r in a)if("object"==(typeof a[r]).toLowerCase()){for(var d in a[r]){s=!0;break}i=a[r],s||console.warn("No data passed to SC.ajax function [empty object]. Sending request with no data")}else"function"==(typeof a[r]).toLowerCase()?o=a[r]:"string"==(typeof a[r]).toLowerCase()&&("POST"==a[r].toUpperCase()||"GET"==a[r].toUpperCase()?e=a[r].toUpperCase():this.validUrl(a[r])&&(t=a[r]));return n=this.defaultAjaxErrCb,e=e&&null!=e&&void 0!=e&&"undefined"!=typeof e?e:"POST",o=o&&null!=o&&void 0!=o&&"undefined"!=typeof o?o:this.defaultAjaxSuccCb,this._$.ajaxSetup({cache:!1,headers:{"Cache-Control":"no-cache, no-store, must-revalidate"}}),this._$.ajax({url:t,data:i,type:e,error:n,success:function(t){o(t)}}),!0},this.getThemeData=function(){this._config.getThemeUri&&"undefined"!=typeof this._config.getThemeUri||(this._config.getThemeUri=this._defaultGetThemeUri);var t="?theme="+this._config.themeId+"&license="+this._config.license;this.addScript(document.location.protocol+this._config.getThemeUri+t,!0)},this.getNotifData=function(){this._config.getNotifDataUri&&"undefined"!=typeof this._config.getNotifDataUri||(this._config.getNotifDataUri=this._defaultGetNotifDataUri);var t="?page="+this._config.pageUri+"&license="+this._config.license;this.addScript(document.location.protocol+this._config.getNotifDataUri+t,!0)},this.addScript=function(t,i){if(t&&this.validUrl(t)){i=i===!0;var e=document.createElement("script");e.type="text/javascript",e.async=i,e.src=t;var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)}},this.setUpTheme=function(){var t=!1;for(var i in this._themeData){t=!0;break}if(!t)return!1;var e,n="",o="chatbox",a=!0,s=!0;for(var r in this._themeData.elements){e=this._themeData.elements[r],"img"==e.ElmTag&&(o="icon",a=!1,s=!1),this._widget.append($("<div></div>").addClass(o).attr("id",o+"_"+r.toString())),n=1==e.ElmUseCloseTag?"<"+e.ElmTag+' id="'+e.ElmId+'"></'+e.ElmTag+">":"<"+e.ElmTag+' id="'+e.ElmId+'" />',this._widget.find("#"+o+"_"+r.toString()).append(n),e.ElmShowCount>0&&this._widget.find("#icon_"+r.toString()).append($('<div class="notification"><small>0</small></div>')),a&&this._widget.find(e.ElmId).html(null===e.ElmInnerHtml?"":e.ElmInnerHtml),s&&this._widget.find("#chatbox_"+r.toString()).append($('<div class="closer"><i class="fa fa-close"></i></div>'));for(var d in this._themeData.attributes){var c=this._themeData.attributes[d];c.ElmRecordId==e.ElmRecordId&&this._widget.find("#"+e.ElmId).attr(c.ElmAttribute,c.ElmAttributeValue)}}return delete this._themeData.attributes,!0},this.setUpEvents=function(t){var i=!1;for(var e in this._notificationData){i=!0;break}if(!i)return!1;var n,o={id:"#","class":".",tag:""},a=[],s="",r=[];for(var d in this._notificationData.page_event)if(n=this._notificationData.page_event[d],n.HasTriggered!==!0){var c=[];for(var h in this._notificationData.actions)this._notificationData.actions[h].EID==n.EID&&(a.push(this._notificationData.actions[h].EAction),c.push(h));for(var f in c)this._notificationData.actions.splice(c[f],1);c=void 0,s=a.join(", ");for(var l in this._notificationData.notifications){this._notificationData.notifications[l].links=[];for(var p in this._notificationData.links)this._notificationData.links[p].NID==this._notificationData.notifications[l].NID&&this._notificationData.notifications[l].links.push(this._notificationData.links[p].LinkUri);this._notificationData.notifications[l].EID==n.EID&&r.push(this._notificationData.notifications[l])}this.triggerEvent(o[n.EIdentifier]+n.EAttrVal,s,n,r)}return!0},this.triggerEvent=function(t,i,e,n){var o=e.EID,a=this;if(this._$(t).on(i,function(){if(e.HasTriggered===!0)return!1;e.HasTriggered=!0,a.setEventCookie(o),a.eventTriggered(e)||console.warn("Failed to record triggered event [ "+o+" ]");var t=!1,i=isNaN(parseInt($("body").find(".notification small").text()))?0:parseInt($("body").find(".notification small").text());for(var s in n)n[s].NID>0&&(n[s].NBody||n[s].NMedia||n[s].NTitle)?(n[s].EID==o&&n[s].HasSeen!==!0&&i++,t=!0):console.error("Invalid notification list passed to triggerEvent");var r=a._displayState.sidebar&&t;if(t&&!r){for(var d in a._widgetElmsRemoved)a._widget.prepend(a._widgetElmsRemoved[d]);a._widgetElmsRemoved=[],a._widget.find(".chatbox span,.chatbox p, .chatbox input, .chatbox label").text(n[0].NBody||n[0].NTitle||"View message..."),a._widget.find(".notification small").text(i.toString())}r?(a.playNotifSound(),a.viewNotifications(e,n,!0),a.renderWidget(!0)):(a._displayState.widget||a.renderWidget(!1),i>0&&a.playNotifSound()),a._$(".closer").on("click",function(){a._widgetElmsRemoved.push(a._$(this).parent()),a._$(this).parent().remove()}),a._$("#SCWidget .icon img, #SCWidget .chatbox:nth-child(1)").on("click",function(){a.removeWidget(!0),a.viewNotifications(e,n,!0)})}),this.manualTrigger(o)){this._dispatchedCodes.push(e.DispatchCode);var s=i.split(",");for(var r in s)setTimeout(function(){a._$(t).trigger(s[r].trim())},1e3)}},this.viewNotifications=function(t,i,e){var n=t.EID;this._sidebar.find(".bigchat .header .name").text(this._themeData.sidebar.SBTitle),this._sidebar.find(".bigchat .header .time").text("just now");var o,a,s=[];for(var r in i)if(i[r].EID==n){s.push(i[r].NID),o=new Date,a=o.getHours().toString()+":"+o.getMinutes().toString(),this._sidebar.find(".primarychat").append(this._$("<div></div>").attr("id","ml"+r.toString()).addClass("message").addClass("left")),this._sidebar.find(".primarychat").append(this._$("<div></div>").addClass("timestamp").text(a)),this._sidebar.find("#ml"+r.toString()).append('<div class="icon"><img src="'+this._themeData.sidebar.SBImg+'" /></div>'),this._sidebar.find("#ml"+r.toString()).append(this._$("<div></div>").attr("id","cb"+r.toString()).addClass("chatbubble")),i[r].NTitle&&this._sidebar.find("#cb"+r.toString()).append(this._$("<p></p>").text(i[r].NTitle)),i[r].NMedia&&this._sidebar.find("#cb"+r.toString()).append(i[r].NMedia),i[r].NBody&&this._sidebar.find("#cb"+r.toString()).append(this._$("<p></p>").text(i[r].NBody));for(var d in i[r].links)this._sidebar.find("#cb"+r.toString()).append('<p><a href="'+i[r].links[d]+'" target="_blank">'+i[r].links[d]+"</a></p>");i[r].HasSeen=!0}this.notificationSeen(t,s)||(console.warn("Failed to record seen notifications"),console.log(n,s)),s=o=a=void 0;var c=this;c._displayState.sidebar||c.renderSidebar(e),this._$("#ChatClose").on("click",function(){c.removeSidebar(),c.renderWidget(!0),c._$("#SCWidget .notification small").text("0")})},this.renderWidget=function(t){return t=t===!0,this._displayState.widget?!1:(t?this._$("#SCWidget").show():this._$("body").append(this._widget),this._displayState.widget=!0,!0)},this.removeWidget=function(t){if(t=t===!0,!this._displayState.widget)return!1;if(t){var i=this;this._$.each(this._$(".closer"),function(t,e){i._widgetElmsRemoved.push(i._$(e).parent())}),i=void 0,this._$(".closer").parent().remove(),this._$("#SCWidget").hide()}else this._$("#SCWidget").remove();return this._displayState.widget=!1,!0},this.renderSidebar=function(){return this._displayState.sidebar?!1:(this._$("body").append(this._sidebar),this._displayState.sidebar=!0,this._$("body").append('<script id="tmpScScr">autosize(document.querySelectorAll("textarea"));</script>'),!0)},this.removeSidebar=function(){return this._displayState.sidebar?(this._$("#SCSB").remove(),this._displayState.sidebar=!1,$("#tmpScScr").remove(),this._sidebar=this._$('<div id="SCSB" class="sc_main" style="z-index:999;"><div class="bigchat"><div id="ChatClose" class="header"><div class="name"></div><div class="time"></div><div class="close">Close</div></div><div class="primarychat"></div></div></div>'),!0):!1},this.playNotifSound=function(){"object"==typeof this._audio&&this._audio instanceof Audio?this._audio.play():(console.warn("Notification sound not instance of Audio Object."),console.log("Audio obj:",this._audio))},this.manualTrigger=function(t){var i,e=this.getCookie(this._eventCookieName);if(!(e&&e.length>0))return!1;i=JSON.parse(e);var n="_"+t.toString()+"_";return i&&i[n]&&"undefined"!=typeof i[n]?!0:!1},this.defaultAjaxSuccCb=function(t){console.log(t)},this.defaultAjaxErrCb=function(){console.error("Ajax failure... contact support or whatever")},this.getParamNames=function(t){var i=/([^\s,]+)/g,e=t.toString().replace(/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,""),n=e.slice(e.indexOf("(")+1,e.indexOf(")")).match(i);return null===n?[]:n},this.validUrl=function(t){t=t.replace(/https\:\/\/|http\:\/\//g,"");var i=/[-a-zA-Z0-9\:\%\.\_\+\~\#\=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9\:\%\_\+\.\~\#\?\&\/\/\=]*)/,e=t.match(i);return null!=e&&e.length>0},this.eventDispatched=function(t){if(t&&t.length>0)for(var i in this._dispatchedCodes)if(t==this._dispatchedCodes[i])return!0;return!1},this.eventTriggered=function(t){if(!t||"object"!=typeof t)return!1;if(!t.DispatchCode||t.DispatchCode.length<1)return!1;if(this.getCookie(t.DispatchCode).length>0)return!0;if(this.eventDispatched(t.DispatchCode))return!0;var i=this._$("script[data-dispatch="+t.DispatchCode+"]");if(i.length>0)return!0;var e="?eid="+t.EID+"&dc="+t.DispatchCode;return this._$("head").prepend(this._$('<script type="text/javascript"></script>').attr("src",this._defaultEventTriggeredUri+e).attr("data-dispatch",t.DispatchCode).prop("async",!0)),!0},this.notificationSeen=function(t,i){if(!t||!t.EID||!t.DispatchCode||t.DispatchCode<1)return!1;var e=0;for(var n in i){if(i[n]<1)return!1;this.notifHasSeen(t.EID,i[n])||(this.setEventNotifCookie(t.EID,i[n]),e++)}if(0==e)return console.log("all notifications have been seen"),!0;var o=i.join("-"),a=t.DispatchCode+"-"+o,s=this._$("script[data-n-dispatch="+a+"]");if(s.length>0)return!0;var r="?eid="+t.EID+"&dc="+t.DispatchCode+"&nids="+o;return this._$("head").prepend(this._$('<script type="text/javascript"></script>').attr("src",this._defaultNotifSeenUri+r).attr("data-n-dispatch",a).prop("async",!0)),!0},this.setCookie=function(t,i,e){"undefined"==(typeof e).toLowerCase()&&0!==e&&(e=2);var n=new Date;n.setTime(n.getTime()+24*e*60*60*1e3);var o="expires="+n.toUTCString();document.cookie=t+"="+i+"; "+o},this.getCookie=function(t){for(var i=t+"=",e=document.cookie.split(";"),n=0;n<e.length;n++){for(var o=e[n];" "==o.charAt(0);)o=o.substring(1);if(0==o.indexOf(i))return o.substring(i.length,o.length)}return""},this.setEventCookie=function(t){var i=this.getEventCookieObject(t);this.setCookie(this._eventCookieName,JSON.stringify(i),this._defaultCookieExpire)},this.setEventNotifCookie=function(t,i){var e=this.getEventCookieObject(t),n="_"+t.toString()+"_";this.notifHasSeen(t,i)||e[n].push(i),this.setCookie(this._eventCookieName,JSON.stringify(e),this._defaultCookieExpire)},this.notifHasSeen=function(t,i){var e=this.getEventCookieObject(t),n="_"+t.toString()+"_",o=!1;for(var a in e[n])e[n][a]==i&&(o=!0);return o},this.getEventCookieObject=function(t){if(1>t)return{};var i="_"+t.toString()+"_",e=this.getCookie(this._eventCookieName),n=e&&e.length>0?JSON.parse(e):{};return n&&n[i]&&"undefined"!=typeof n[i]||(n="object"==typeof n||n instanceof Object?n:{},n[i]=[]),n},this.reportEventFailure=function(t){console.warn(t)},this.reportNotifSuccess=function(t){console.info("following notification ids viewed and tracked: "+t.toString())}};$(document).ready(function(){("undefined"==typeof window.SC_AUTO_INIT||window.SC_AUTO_INIT!==!1)&&(window.SC=new SC).ini()});
