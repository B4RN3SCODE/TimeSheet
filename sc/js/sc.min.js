"use strict";var SC=function(i){this._config=i&&"object"==(typeof i).toLowerCase()?i:{},this._$="undefined"==typeof jQuery?-1:jQuery,this._themeData={},this._notificationData={},this._widget=-1===this._$?"":this._$('<div id="SCWidget" class="sc_main"></div>'),this._sidebar=-1===this._$?"":this._$('<div id="SCSB" class="sc_main"><div class="bigchat"><div class="header"><div class="name"></div><div class="time"></div><div id="ChatClose" class="close"><i class="fa fa-close"></i></div></div><div class="primarychat"></div></div></div>'),this._widgetDisplayed=!1,this._sidebarDisplayed=!1,this._defaultGetThemeUri="http://www.barnescode.com/sc/include/getTheme.php",this._defaultGetNotifDataUri="http://www.barnescode.com/sc/include/getNotifData.php",this.ini=function(){var i=window.location;if(this.installJsCss(document),-1==this._$||"undefined"==typeof this._$)return console.error("Snake Charmer Relies on jQuery. Please include jQuery library on your web page"),!1;var t=["license","themeId"];for(var e in t)if(!(t[e]in this._config)){console.info("Using default configuration for Snake Charmer"),this._config=void 0;break}"undefined"==typeof this._config?this._config=this.getDefaultConfig():this._config.pageUri=this._config.pageUri&&this._config.pageUri.length>0?this._config.pageUri:i.protocol+"//"+i.hostname+i.pathname,this.getThemeData(),this.getNotifData()},this.installJsCss=function(i){this._$("head").append('<link type="text/css" rel="stylesheet" href="http://www.barnescode.com/sc/css/style.css"><script src="//www.barnescode.com/sc/js/autosize.min.js"></script>')},this.getDefaultConfig=function(){var i={},t=this._$("#SCJS").attr("src"),e=t.split("?")[1].split("&"),a=[];for(var s in e)a=e[s].split("="),i[a[0]]=a[1];return i.pageUri=window.location.protocol+"//"+window.location.hostname+window.location.pathname,i},this.ajax=function(){var i,t,e,a,s,n=arguments,o=!1;if(n.length<2)return console.error("Invalid arguments passed to ajax function. Required: target_url, data_to_send"),!1;for(var r in n)if("object"==(typeof n[r]).toLowerCase()){for(var d in n[r]){o=!0;break}t=n[r],o||console.warn("No data passed to SC.ajax function [empty object]. Sending request with no data")}else"function"==(typeof n[r]).toLowerCase()?s=n[r]:"string"==(typeof n[r]).toLowerCase()&&("POST"==n[r].toUpperCase()||"GET"==n[r].toUpperCase()?e=n[r].toUpperCase():this.validUrl(n[r])&&(i=n[r]));return a=this.defaultAjaxErrCb,e=e&&null!=e&&void 0!=e&&"undefined"!=typeof e?e:"POST",s=s&&null!=s&&void 0!=s&&"undefined"!=typeof s?s:this.defaultAjaxSuccCb,this._$.ajaxSetup({cache:!1,headers:{"Cache-Control":"no-cache, no-store, must-revalidate"}}),this._$.ajax({url:i,data:t,type:e,error:a,success:function(i){s(i)}}),!0},this.getThemeData=function(){this._config.getThemeUri&&"undefined"!=typeof this._config.getThemeUri||(this._config.getThemeUri=this._defaultGetThemeUri);var i=this;this.ajax(this._config.getThemeUri,{theme:this._config.themeId,license:this._config.license},function(){console.log("err")},function(t){i.setUpTheme(t)})},this.getNotifData=function(){this._config.getNotifDataUri&&"undefined"!=typeof this._config.getNotifDataUri||(this._config.getNotifDataUri=this._defaultGetNotifDataUri);var i=this;this.ajax(this._config.getNotifDataUri,{page:this._config.pageUri,license:this._config.license},function(){console.log("err")},function(t){i.setUpEvents(t)})},this.setUpTheme=function(i){this._themeData=i;var t,e="",a="chatbox",s=!0,n=!0;for(var o in this._themeData.elements){t=this._themeData.elements[o],"img"==t.ElmTag&&(a="icon",s=!1,n=!1),this._widget.append($("<div></div>").addClass(a).attr("id",a+"_"+o.toString())),e=1==t.ElmUseCloseTag?"<"+t.ElmTag+' id="'+t.ElmId+'"></'+t.ElmTag+">":"<"+t.ElmTag+' id="'+t.ElmId+'" />',this._widget.find("#"+a+"_"+o.toString()).append(e),t.ElmShowCount>0&&this._widget.find("#icon_"+o.toString()).append($('<div class="notification"><small>0</small></div>')),s&&this._widget.find(t.ElmId).html(null===t.ElmInnerHtml?"":t.ElmInnerHtml),n&&this._widget.find("#chatbox_"+o.toString()).append($('<div class="closer"><i class="fa fa-close"></i></div>'));for(var r in this._themeData.attributes){var d=this._themeData.attributes[r];d.ElmRecordId==t.ElmRecordId&&this._widget.find("#"+t.ElmId).attr(d.ElmAttribute,d.ElmAttributeValue)}}delete this._themeData.attributes},this.setUpEvents=function(i){this._notificationData=i;var t,e={id:"#","class":".",tag:""},a=[],s="",n=[];for(var o in this._notificationData.page_event){t=this._notificationData.page_event[o];var r=[];for(var d in this._notificationData.actions)this._notificationData.actions[d].EID==t.EID&&(a.push(this._notificationData.actions[d].EAction),r.push(d));for(var c in r)this._notificationData.actions.splice(r[c],1);r=void 0,s=a.join(", ");for(var h in this._notificationData.notifications){this._notificationData.notifications[h].links=[];var l=[];if(this._notificationData.notifications[h].EID==t.EID){for(var f in this._notificationData.links)this._notificationData.links[f].NID==this._notificationData.notifications[h].NID&&(this._notificationData.notifications[h].links.push(this._notificationData.links[f].LinkUri),l.push(f));for(var g in l)this._notificationData.links.splice(l[g],1);l=void 0,n.push(this._notificationData.notifications[h])}}this.triggerEvent(e[t.EIdentifier]+t.EAttrVal,s,t.EID,n)}},this.triggerEvent=function(i,t,e,a){var s=this;this._$(i).on(t,function(){console.log("triggering event: "+e.toString()),s.eventTriggered(e)||console.warn("Failed to record triggered event [ "+e+" ]");var i=!1;for(var t in a)a[t].NID>0&&(a[t].NBody||a[t].NMedia||a[t].NTitle)?i=!0:(console.error("Invalid notification list passed to triggerEvent"),console.log(a[t]));i&&(s._widget.find(".chatbox span,.chatbox p, .chatbox input, .chatbox label").text(a[0].NBody||a[0].NTitle||"View message..."),s._widget.find(".notification small").text(a.length.toString())),s._widgetDisplayed||s.renderSc("widget"),s._$(".closer").on("click",function(){s.removeSc("widget")}),s._$(".sc_main").on("click",function(){s.removeSc("widget"),s.viewNotifications(e,a)})})},this.viewNotifications=function(i,t){this._sidebar.find(".bigchat .header .name").text(this._themeData.sidebar.SBTitle),this._sidebar.find(".bigchat .header .time").text("just now");var e,a,s=[];for(var n in t)t[n].EID==i&&(s.push(t[n].NID),e=new Date,a=e.getHours().toString()+":"+e.getMinutes().toString(),this._sidebar.find(".primarychat").append(this._$("<div></div>").attr("id","ml"+n.toString()).addClass("message").addClass("left")),this._sidebar.find(".primarychat").append(this._$("<div></div>").addClass("timestamp").text(a)),this._sidebar.find("#ml"+n.toString()).append('<div class="icon"><img src="'+this._themeData.sidebar.SBImg+'" /></div>'),this._sidebar.find("#ml"+n.toString()).append(this._$("<div></div>").attr("id","cb"+n.toString()).addClass("chatbubble")),t[n].NTitle&&this._sidebar.find("#cb"+n.toString()).append(this._$("<p></p>").text(t[n].NTitle)),t[n].NMedia&&this._sidebar.find("#cb"+n.toString()).append(t[n].NMedia),t[n].NBody&&this._sidebar.find("#cb"+n.toString()).append(this._$("<p></p>").text(t[n].NBody)));this.notificationSeen(i,s)||(console.warn("Failed to record seen notifications"),console.log(i,s)),s=e=a=void 0;var o=this;this._sidebarDisplayed||this.renderSc("sidebar"),this._$("#ChatClose").on("click",function(){o.removeSc("sidebar")}),this._$("body").append('<script id="tmpScScr">autosize(document.querySelectorAll("textarea"));</script>')},this.renderSc=function(i){if("widget"===i&&this._widgetDisplayed||"sidebar"===i&&this._sidebarDisplayed)return!1;var t="_"+i,e="_"+i+"Displayed";return this._$("body").append(this[t]),this[e]=!0,!0},this.removeSc=function(i){if("widget"===i&&!this._widgetDisplayed||"sidebar"===i&&!this._sidebarDisplayed)return!1;var t="widget"===i?"#SCWidget":"#SCSB",e="_"+i+"Displayed";return $(t).remove(),$("#tmpScScr").remove(),this[e]=!1,"sidebar"===i&&(this._sidebar=-1===this._$?"":this._$('<div id="SCSB" class="sc_main"><div class="bigchat"><div class="header"><div class="name"></div><div class="time"></div><div id="ChatClose" class="close"><i class="fa fa-close"></i></div></div><div class="primarychat"></div></div></div>')),!0},this.defaultAjaxSuccCb=function(i){console.log(i)},this.defaultAjaxErrCb=function(){console.error("Ajax failure... contact support or whatever")},this.getParamNames=function(i){var t=/([^\s,]+)/g,e=i.toString().replace(/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,""),a=e.slice(e.indexOf("(")+1,e.indexOf(")")).match(t);return null===a?[]:a},this.validUrl=function(i){i=i.replace(/https\:\/\/|http\:\/\//g,"");var t=/[-a-zA-Z0-9\:\%\.\_\+\~\#\=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9\:\%\_\+\.\~\#\?\&\/\/\=]*)/,e=i.match(t);return null!=e&&e.length>0},this.eventTriggered=function(i){console.log(i)},this.notificationSeen=function(i,t){console.log(i,t)}};$(document).ready(function(){("undefined"==typeof window.SC_AUTO_INIT||window.SC_AUTO_INIT!==!1)&&(window.SC=new SC).ini()});
